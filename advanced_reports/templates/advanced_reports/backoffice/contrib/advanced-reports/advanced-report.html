{% load i18n %}

<script type="text/ng-template" id="/pagination.html">
    <p ng-show="report">
        <span ng-show="search.page > 1"><a href ng-click="change_page(1)">&lt;&lt;</a></span>
        <span ng-show="search.page > 1"><a href ng-click="change_page(search.page-1)">&lt;</a></span>
        {% trans "Page {{ search.page }} of {{ page_count }}" %}
        <span ng-show="search.page < page_count"><a href ng-click="change_page(search.page+1)">&gt;</a></span>
        <span ng-show="search.page < page_count"><a href ng-click="change_page(page_count)">&gt;&gt;</a></span>
    </p>
</script>

<div ng-controller="AdvancedReportCtrl">
    <div class="alert alert-success alert-dismissable" ng-show="success">
        <button type="button" class="close" ng-click="success=null" aria-hidden="true">&times;</button>
        {% verbatim %}
        {{ success }}
        {% endverbatim %}
    </div>

    <div class="modal fade" tabindex="-1" role="dialog" bo-element="action_form_popup">
        <div class="modal-dialog-extra-padding modal-dialog">
            <div class="modal-content">
                <form bo-element="action_form_form">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" ng-bind="form.verbose_name"></h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-horizontal" role="form" ng-bind-html-unsafe="form.form"></div>
                    </div>
                    <div class="modal-footer">
                        <button ng-disabled="isLoading()" type="button" class="btn btn-default" ng-click="action_form_popup.modal('hide')">{% trans "Cancel" %}</button>
                        <input ng-disabled="isLoading()" type="submit" class="btn btn-primary" ng-click="submit_form(form)" value="{% templatetag openvariable %}form.submit||'{% trans "Submit" %}'{% templatetag closevariable %}">
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" tabindex="-1" role="dialog" bo-element="action_confirm_popup">
        <div class="modal-dialog-extra-padding modal-dialog">
            <div class="modal-content">
                <form>
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">{% trans "Are you sure?" %}</h4>
                    </div>
                    <div class="modal-body" ng-bind="action_to_confirm.confirm"></div>
                    <div class="modal-footer">
                        <button ng-disabled="isLoading()" type="button" class="btn btn-default" ng-click="action_confirm_popup.modal('hide')">{% trans "Cancel" %}</button>
                        <input ng-disabled="isLoading()" type="submit" class="btn btn-primary" ng-click="action_to_confirm.execute()" value="{% verbatim %}{{ action_to_confirm.verbose_name }}{% endverbatim %}">
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" tabindex="-1" role="dialog" bo-element="error_popup">
        <div class="modal-dialog-extra-padding modal-dialog">
            <div class="modal-content alert-danger">
                <form>
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">{% trans "Error" %}</h4>
                    </div>
                    <div class="modal-body" ng-bind="error_message"></div>
                    <div class="modal-footer">
                        <button ng-disabled="isLoading()" type="button" class="btn btn-danger" ng-click="error_popup.modal('hide')">{% trans "Close" %}</button>
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" tabindex="-1" role="dialog" bo-element="detail_popup">
        <div class="modal-dialog-extra-padding modal-dialog">
            <div class="modal-content">
                <form>
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" ng-bind="detail_action.verbose_name"></h4>
                    </div>
                    <div class="modal-body" compile="detail_action_content"></div>
                    <div class="modal-footer">
                        <button ng-disabled="isLoading()" type="button" class="btn btn-primary" ng-click="detail_popup.modal('hide')">{% trans "Close" %}</button>
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div ng-show="report.show_action_bar" class="well">
        <form class="form-inline" role="form" ng-submit="apply_filters()">
            <div class="form-group" ng-show="report.search_fields">
                <input type="text" class="form-control" ng-model="filters.q" title="{% templatetag openvariable %}report.searchable_columns{% templatetag closevariable %}">
            </div>
            {% verbatim %}
            <div class="form-group" ng-repeat="field in report.filter_fields" ng-show="report.filter_fields">
                <select class="form-control" ng-model="$parent.filters[field]">
                  <option ng-repeat="(value, name) in report.filter_values[field]" value="{{value}}">{{name}}</option>
                </select>
            </div>
            {% endverbatim %}
            <button type="submit" class="btn btn-primary">Search</button>
            <div class="checkbox">
                <label><a href ng-show="has_applied_filters()" ng-click="remove_filters()">{% trans "show all" %}</a></label>
            </div>
        </form>
    </div>
    
    <div ng-include="'/pagination.html'"></div>

    <div class="tablecontainer" ng-show="report">
        <table class="data table table-hover">
            <tr>
                <th ng-repeat="column in report.header" ng-style="column.style">
                    <span ng-bind="column.verbose_name" ng-show="!column.sortable"></span>
                    <a href ng-bind="column.verbose_name" ng-show="column.sortable" ng-click="change_order(column.order_by)"></a>
                    <span ng-show="report.extra.order_field==column.name" ng-bind="{true:'&darr;', false:'&uarr;'}[report.extra.ascending]"></span>
                </th>
            </tr>

            <tbody ng-repeat="item in report.items">
                <tr ng-click="toggle_expand(item)">
                    <td ng-repeat="value in item.values" ng-bind-html-unsafe="value.html" ng-style="value.style" ng-class="value.class"></td>
                </tr>
                {% verbatim %}
                <tr ng-show="item.expanded">
                    <td colspan="{{ report.header.length }}">
                        <div class="btn-group">
                            <a class="btn btn-default" link-to="get_action_link(item, action)" ng-click="execute_action(item, action)" ng-repeat="action in item.actions|filter:is_button_action">{{ action.verbose_name }}</a>
                        </div>
                        <div ng-repeat="action in item.actions|filter:is_inline_form_action">
                            <form bo-element="action_form_element" ng-submit="execute_inline_form_action(item, action, action_form_element)">
                                <div class="form-inline" role="form" compile="action.form"></div>
                            </form>
                        </div>
                        <div compile="item.extra_information" class="row extra_info"></div>
                    </td>
                </tr>
                {% endverbatim %}
            </tbody>
            {% if advreport.row_footer_subtotal_calculation_field %}
                {% include advreport.row_footer_subtotal_template %}
            {% endif %}
        </table>
    </div>

    <div ng-include="'/pagination.html'"></div>
</div>

<script type="text/javascript">
function AdvancedReportCtrl($scope, $http, $location, boUtils, $timeout) {
    $scope.report = null;
    $scope.page_count = null;
    $scope.filters = {};
    $scope.applied_filters = {};
    $scope.search = $location.search() || {};

    $scope.$watch(function(){
        return $location.search();
    }, function(search){
        $scope.search = search;
        $scope.fetch_report();
    }, true);

    $scope.fetch_report = function() {
        if (!$scope.search.page)
            $scope.search.page = 1;

        for (var j in $scope.search){
            if (typeof $scope.search[j] === 'undefined')
                delete $scope.search[j];
        }

        if ($scope.view.params.updateLocation)
            $location.search($scope.search);

        var qs_list = [];
        for (var k in $scope.search)
            qs_list.push(encodeURIComponent(k) + '=' + encodeURIComponent($scope.search[k]));
        var qs = '?' + qs_list.join('&');

        $scope.view.action('fetch', {}, false, qs).then(function(data){
            $scope.report = data;
            if (data.item_count == 1)
                $scope.toggle_expand($scope.report.items[0]);
            $scope.page_count = Math.floor(data.item_count / data.items_per_page) + 1;
        }, function(error){
            $scope.error = error;
        });
    };

    $scope.change_page = function(page) {
        $scope.search.page = page;
        $scope.fetch_report();
    };

    $scope.toggle_expand = function(item) {
        if (!item.expanded && (item.extra_information.length > 0 || item.actions.length > 0)) {
            item.expanded = true;
            $scope.$broadcast('item_expanded', item.item_id);
            $scope.fetch_lazy_divs(item);
        } else {
            item.expanded = false;
        }
    };

    $scope.change_order = function(order_by) {
        var ascending = $scope.report.extra.order_by != order_by || !$scope.report.extra.ascending;
        $scope.search.order = (ascending ? '' : '-') + order_by;
        $scope.search.page = 1;
        $scope.fetch_report();
    };

    $scope.has_applied_filters = function() {
        var count = 0;
        for (var key in $scope.search)
            if (key != 'order' && key != 'page')
                count += 1;
        return count > 0;
    };

    $scope.apply_filters = function() {
        $scope.search = {order: $scope.search.order};
        for (var k in $scope.filters)
            $scope.search[k] = $scope.filters[k];
        $scope.search.page = 1;
        $scope.fetch_report();
    };

    $scope.remove_filters = function() {
        $scope.loader='search';
        $scope.filter = {};
        $scope.search = {order: $scope.search.order};
        $scope.search.page = 1;
        $scope.fetch_report();
    };

    $scope.update_item = function(item, new_item, expand_next) {
        for (var key in new_item) {
            if (new_item.hasOwnProperty(key))
                item[key] = new_item[key];
        }
        if (expand_next)
        {
            var this_item_id = $scope.report.items.indexOf(item);
            if (this_item_id < $scope.report.items.length - 1)
            {
                $scope.toggle_expand(item);
                $scope.toggle_expand($scope.report.items[this_item_id+1]);
            }
        }

        $scope.fetch_lazy_divs(item);
    };

    $scope.execute_action = function(item, action, force) {
        if ($scope.is_link_action(action))
            return;

        if (action.form){
            $scope.form = action;
            $scope.form.item = item;
            $scope.action_form_popup.modal('show');
        } else {
            var execute = function(){
                $scope.view.action('action', {method: action.method, pk: item.item_id}, false).then(function(data){
                    $scope.action_confirm_popup.modal('hide');
                    if (data.item){
                        $scope.update_item(item, data.item, action.next_on_success);
                        $scope.show_success(data.success);
                    } else {
                        $scope.detail_action = action;
                        $scope.detail_action_content = data;
                        $scope.detail_popup.modal('show');
                    }

                }, function(error){
                    $scope.action_confirm_popup.modal('hide');
                    $scope.show_error(error);
                });
            };

            if (action.confirm && !force){
                action.execute = execute;
                $scope.action_to_confirm = action;
                $scope.action_confirm_popup.modal('show');
            } else {
                execute();
            }
        }
    };

    $scope.show_success = function(success){
        $scope.success = success;
        $timeout(function(){
            $scope.success = null;
        }, 5000);
    };

    $scope.show_error = function(error){
        $scope.error_message = error;
        $scope.error_popup.modal('show');
    };

    $scope.submit_form = function(form) {
        var data = $scope.action_form_form.serialize();
        var item = form.item;

        $scope.view.action('action', {method: form.method, pk: item.item_id, data: data}, false).then(function(result){
            if (result.success){
                $scope.update_item(item, result.item, form.next_on_success);
                $scope.form = null;
                $scope.action_form_popup.modal('hide');
            }else{
                form.form = result.response_form;
                $scope.form = form;
            }
        }, function(error){
            $scope.action_form_popup.modal('hide');
            $scope.show_error(error);
        });
    };

    $scope.execute_inline_form_action = function(item, action, action_form_element){
        var data = action_form_element.serialize();
        $scope.view.action('action', {method: action.method, pk: item.item_id, data: data}, false).then(function(result){
            if (result.success){
                $scope.update_item(item, result.item, action.next_on_success);
            }else{
                action.form = result.response_form;
            }
        }, function(error){
            alert(error);
        });
    };

    $scope.fetch_lazy_divs = function(item) {
        var binds = item.extra_information.split('ng-bind-html-unsafe="');
        binds.splice(0, 1);

        var fetchBindIndex = function(i) {
            var bind = binds[i].split('"')[0];
            binds[i] = bind;
            var parts = bind.split('__');
            if (parts[0] == 'lazydiv')
            {
                $http.get($scope.settings.base + 'action/' + parts[2] + '/' + parts[1] + '/').
                success(function(data, status) {
                    $scope[bind] = data;
                }).
                error(function(data, status) {
                    $scope[bind] = 'error';
                });
            }
        };

        for (var i = 0; i < binds.length; i++) {
            fetchBindIndex(i);
        }
    };

    $scope.is_button_action = function(action){
        return !action.form || action.form_via_ajax;
    };

    $scope.is_inline_form_action = function(action){
        return action.form && !action.form_via_ajax;
    };

    $scope.is_link_action = function(action){
        return boUtils.endsWith(action.method, '_view');
    };

    $scope.get_action_link = function(item, action){
        if ($scope.is_link_action(action))
            return $scope.view.action_link('action_view', {report_method: action.method, pk: item.item_id});
        return '';
    };
}
</script>
